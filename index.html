<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>⚡ Neon Runner WOW - Ultra Fluid 60+ FPS | LIPA Studios</title>
    <meta name="description" content="Play Neon Runner WOW, the most fluid endless runner! 60+ FPS, epic effects, mega combos. Ultra optimized HTML5 game by LIPA Studios.">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0');
        
        window.trackDonationClick = function(amount = 'custom') {
            gtag('event', 'donation_click', {
                source: 'neon_runner_wow',
                amount: amount,
                value: parseFloat(amount) || 1
            });
        };
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4837743291717475"
         crossorigin="anonymous"></script>
    <!-- Consent Mode v2 + Banner -->
    <script defer src="consent.js"></script>
    <!-- Leaderboard System -->
    <script src="leaderboard-system.js"></script>
    
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="iyEAsCuQ7tncHUvc1e09D9gDHOt0nzPQByhGu1xzq54" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #111 50%, #000 100%);
            color: #00FFFF;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(180deg, #000 0%, #111 50%, #000 100%);
            cursor: pointer;
            will-change: transform;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #00FFFF;
            text-shadow: 0 0 10px #00FFFF;
            will-change: transform;
        }
        
        .combo-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #FF00FF;
            text-shadow: 0 0 15px #FF00FF;
            will-change: transform;
        }
        
        .fps-display {
            position: absolute;
            top: 60px;
            left: 20px;
            font-size: 14px;
            color: #00FF00;
            font-family: monospace;
        }
        
        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000 0%, #111 50%, #000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        .game-title {
            font-size: 48px;
            font-weight: bold;
            color: #00FFFF;
            text-shadow: 0 0 20px #00FFFF;
            margin-bottom: 20px;
            animation: titlePulse 2s infinite;
        }
        
        .wow-subtitle {
            font-size: 24px;
            color: #FF00FF;
            text-shadow: 0 0 15px #FF00FF;
            margin-bottom: 40px;
            animation: subtitleGlow 1.5s infinite alternate;
        }
        
        .start-button {
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, #00FFFF, #FF00FF);
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px #00FFFF;
            will-change: transform;
        }
        
        .start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px #FF00FF;
        }
        
        .donate-button {
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6600, #ffff00);
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px #ff6600;
            will-change: transform;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
        }
        
        .donate-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px #ff6600;
        }
        
        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }
        
        .game-over-title {
            font-size: 36px;
            color: #FF0000;
            text-shadow: 0 0 15px #FF0000;
            margin-bottom: 20px;
        }
        
        .final-score {
            font-size: 24px;
            color: #00FFFF;
            margin-bottom: 30px;
        }
        
        .restart-button {
            padding: 12px 25px;
            font-size: 18px;
            background: linear-gradient(45deg, #FF00FF, #00FFFF);
            color: #000;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .restart-button:hover {
            transform: scale(1.05);
        }
        
        /* AdSense Banners */
        .ad-banner {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FFFF;
            z-index: 5;
        }
        
        .top-banner {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 50px;
        }
        
        .bottom-banner {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 50px;
        }
        
        .side-banner {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 120px;
            height: 600px;
            transition: opacity 0.3s ease;
        }
        
        /* OCULTAR BANNER DURANTE EL JUEGO - NUNCA MOSTRAR */
        .game-screen .side-banner {
            display: none !important;
        }
        
        /* MOSTRAR BANNER SOLO EN MENÚ Y GAME OVER */
        .menu-screen .side-banner,
        .gameover-screen .side-banner {
            display: block !important;
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Animations */
        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes subtitleGlow {
            0% { text-shadow: 0 0 15px #FF00FF; }
            100% { text-shadow: 0 0 25px #FF00FF, 0 0 35px #FF00FF; }
        }
        
        @keyframes particleFloat {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .screen-shake {
            animation: screenShake 0.3s ease-in-out;
        }
        
        /* Leaderboard Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00FFFF;
            border-radius: 8px;
            color: #00FFFF;
            font-size: 16px;
            font-weight: bold;
        }
        
        .leaderboard-item.current-user {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .leaderboard-item .rank {
            width: 30px;
            font-size: 18px;
        }
        
        .leaderboard-item .medal {
            width: 30px;
            font-size: 20px;
            text-align: center;
        }
        
        .leaderboard-item .username {
            flex: 1;
            margin: 0 10px;
            text-align: left;
        }
        
        .leaderboard-item .score {
            width: 80px;
            text-align: right;
            color: #00FF00;
        }
        
        .leaderboard-item .level {
            width: 60px;
            text-align: right;
            color: #FF00FF;
            font-size: 14px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .game-title { font-size: 36px; }
            .wow-subtitle { font-size: 18px; }
            .start-button { padding: 12px 24px; font-size: 18px; }
            .side-banner { display: none; }
            
            /* Mobile game area */
            #gameCanvas {
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Mobile UI */
            .score-display { font-size: 20px; top: 10px; left: 10px; }
            .combo-display { font-size: 18px; top: 10px; right: 10px; }
            .fps-display { font-size: 12px; top: 40px; left: 10px; }
            
            /* Mobile buttons */
            .start-button, .restart-button {
                padding: 15px 25px;
                font-size: 18px;
                min-height: 50px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .game-title { font-size: 28px; }
            .wow-subtitle { font-size: 16px; }
            .score-display { font-size: 18px; }
            .combo-display { font-size: 16px; }
            .start-button, .restart-button {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <div class="score-display" id="scoreDisplay">SCORE: 0</div>
            <div class="combo-display" id="comboDisplay">COMBO: 1x</div>
            <div class="fps-display" id="fpsDisplay">FPS: 60</div>
        </div>
        
        <div class="menu-screen" id="menuScreen">
            <h1 class="game-title">⚡ NEON RUNNER WOW</h1>
            <p class="wow-subtitle">Ultra Fluid 60+ FPS Experience</p>
            <button class="start-button" onclick="startGame()">🚀 START RUNNING</button>
            <button class="start-button" onclick="showLeaderboard('neon-runner-wow')" style="background: linear-gradient(45deg, #FFD700, #FFA500); margin-top: 10px;">🏆 RANKING</button>
            <div class="donation-section">
                <h3 style="color: #FFFF00; margin-bottom: 15px;">💖 ¡Apoya el desarrollo!</h3>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="padding: 12px 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">☕ 0,50€</a>
                    <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #FF9800, #FFC107); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">🍕 2€</a>
                    <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #E91E63, #F06292); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">🎮 5€</a>
                </div>
            </div>
        </div>
        
        <div class="game-over-screen" id="gameOverScreen">
            <h2 class="game-over-title">GAME OVER</h2>
            <div class="final-score" id="finalScore">SCORE: 0</div>
            <div style="margin-top: 20px;">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #FFFF00; margin-bottom: 15px;">💖 ¡Apoya el desarrollo!</h3>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                        <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="padding: 12px 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">☕ 0,50€</a>
                        <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #FF9800, #FFC107); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">🍕 2€</a>
                        <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #E91E63, #F06292); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">🎮 5€</a>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button class="restart-button" onclick="restartGame()">🔄 PLAY AGAIN</button>
                    <button class="restart-button" onclick="shareScore()" style="background: linear-gradient(45deg, #FF0080, #00FFFF); color: white; border: 3px solid #FFFFFF; font-size: 1.2rem; padding: 15px 25px; box-shadow: 0 0 20px #FF0080;">📱 COMPARTIR VIRAL</button>
                </div>
            </div>
        </div>
        
        <!-- Leaderboard Screen -->
        <div class="game-over-screen" id="leaderboard-screen" style="display: none;">
            <h2 class="game-over-title">🏆 RANKING DIARIO</h2>
            <div style="max-height: 60vh; overflow-y: auto; margin: 20px 0; padding: 0 20px;">
                <ul id="leaderboard-list" style="list-style: none; padding: 0; margin: 0;">
                    <!-- Leaderboard items will be populated by JavaScript -->
                </ul>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <button class="restart-button" onclick="hideLeaderboard()">🔙 VOLVER</button>
            </div>
        </div>
        
        <!-- AdSense Banners -->
        <div class="ad-banner top-banner" id="topBanner" style="display: none;">
            <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
        </div>
        
        <div class="ad-banner bottom-banner" id="bottomBanner" style="display: none;">
            <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
        </div>
        
        <div class="ad-banner side-banner" id="sideBanner" style="display: none;">
            <ins class="adsbygoogle" style="display:block;width:120px;height:600px;" data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
        </div>
    </div>

    <script>
        // ===== ULTRA OPTIMIZED GAME ENGINE =====
        class UltraOptimizedGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // DETECCIÓN DE DISPOSITIVO DE GAMA BAJA (SAMSUNG/ANDROID)
                this.isLowEndDevice = this.detectLowEndDevice();
                console.log('🔧 Dispositivo de gama baja detectado:', this.isLowEndDevice);
                
                this.gameState = {
                    running: false,
                    score: 0,
                    combo: 1,
                    speed: 4,
                    fps: 60,
                    lastTime: 0,
                    deltaTime: 0
                };
                
                this.runner = {
                    x: 100,
                    y: 0, // Se posicionará correctamente en setupCanvas
                    width: 300, // Tamaño fijo inicial
                    height: 400, // Tamaño fijo inicial
                    velocityY: 0,
                    velocityX: 0, // Nueva: velocidad horizontal
                    onGround: true,
                    dashCooldown: 0,
                    invulnerable: 0,
                    maxSpeed: 8, // Nueva: velocidad máxima horizontal
                    friction: 0.8 // Nueva: fricción para frenar
                };
                
                this.obstacles = [];
                this.particles = [];
                this.powerUps = [];
                this.gems = [];
                
                this.keys = {};
                this.touch = { active: false, startY: 0 };
                
                this.setupCanvas();
                this.setupEventListeners();
                this.setupAdSense();
                this.gameLoop();
            }
            
            detectLowEndDevice() {
                // Detectar dispositivos Samsung/Android de gama baja
                const userAgent = navigator.userAgent.toLowerCase();
                const isAndroid = /android/.test(userAgent);
                const isSamsung = /samsung/.test(userAgent) || /sm-/.test(userAgent);
                const isLowRAM = navigator.deviceMemory && navigator.deviceMemory < 4; // Menos de 4GB RAM
                const isSlowCPU = navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4; // Menos de 4 cores
                
                // Detectar por User Agent específicos de Samsung de gama baja
                const lowEndSamsung = /sm-a|sm-j|sm-g3|sm-g5|sm-g7|sm-g9|sm-t2|sm-t3|sm-t5|sm-t7|sm-p/.test(userAgent);
                
                return (isAndroid && (isSamsung || lowEndSamsung)) || isLowRAM || isSlowCPU;
            }
            
            setupCanvas() {
                // Get viewport dimensions
                const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
                const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
                
                // Set canvas size - SIMPLE Y DIRECTO
                this.canvas.width = vw;
                this.canvas.height = vh;
                this.canvas.style.width = vw + 'px';
                this.canvas.style.height = vh + 'px';
                
                // CORREDOR PEQUEÑO Y SOBRE EL SUELO
                this.runner.width = 45;   // MÁS PEQUEÑO
                this.runner.height = 60;  // MÁS PEQUEÑO
                this.runner.x = 50;       // MÁS A LA IZQUIERDA
                this.runner.y = vh * 0.75; // 75% DE LA PANTALLA (SOBRE EL SUELO)
                
                console.log(`🚀 CORREDOR GIGANTE: x=${this.runner.x}, y=${this.runner.y}, w=${this.runner.width}, h=${this.runner.height}`);
                console.log(`📐 Canvas: ${vw}x${vh}`);
            }
            
            setupEventListeners() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.jump();
                        console.log('🏃‍♂️ SPACE pressed - Jump!');
                    } else if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                        e.preventDefault();
                        this.moveLeft();
                    } else if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                        e.preventDefault();
                        this.moveRight();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Touch - mejorado para móvil
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.touch.active = true;
                    this.touch.startY = e.touches[0].clientY;
                    this.jump();
                    console.log('Touch start - Jump!');
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.touch.active = false;
                }, { passive: false });
                
                // Touch move for horizontal movement
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.gameState.gameActive && e.touches.length > 0) {
                        const touch = e.touches[0];
                        const rect = this.canvas.getBoundingClientRect();
                        const touchX = touch.clientX - rect.left;
                        const canvasWidth = this.canvas.width / window.devicePixelRatio;
                        
                        // Move runner based on touch position
                        if (touchX < canvasWidth * 0.3) {
                            this.moveLeft();
                        } else if (touchX > canvasWidth * 0.7) {
                            this.moveRight();
                        }
                    }
                }, { passive: false });
                
                // Touch cancel
                this.canvas.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    this.touch.active = false;
                }, { passive: false });
                
                // Mouse
                this.canvas.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.jump();
                    console.log('🖱️ CLICK - Jump!');
                });
                
                // Resize
                window.addEventListener('resize', () => {
                    this.setupCanvas();
                });
            }
            
            setupAdSense() {
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch(e) {
                    console.log('AdSense not loaded yet');
                }
            }
            
            jump() {
                if (!this.gameState.running) return;
                
                console.log('🏃‍♂️ JUMP! - Runner on ground:', this.runner.onGround);
                
                if (this.runner.onGround) {
                    this.runner.velocityY = -12; // Velocidad de salto
                    this.runner.onGround = false;
                    this.createJumpParticles();
                    console.log('✅ Salto ejecutado');
                } else if (this.runner.dashCooldown <= 0) {
                    // Dash ability en el aire
                    this.runner.velocityY = -15;
                    this.runner.dashCooldown = 60; // 1 second at 60fps
                    this.createDashEffect();
                    this.gameState.combo += 2;
                    console.log('✅ Dash ejecutado');
                }
            }
            
            moveLeft() {
                if (!this.gameState.running) return;
                this.runner.velocityX = -this.runner.maxSpeed;
                console.log('Moving left');
            }
            
            moveRight() {
                if (!this.gameState.running) return;
                this.runner.velocityX = this.runner.maxSpeed;
                console.log('Moving right');
            }
            
            createJumpParticles() {
                // OPTIMIZADO PARA SAMSUNG - MENOS PARTÍCULAS PERO MÁS EFICIENTES
                const particleCount = this.isLowEndDevice ? 8 : 12; // Detectar dispositivo de gama baja
                
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push({
                        x: this.runner.x + this.runner.width / 2,
                        y: this.runner.y + this.runner.height,
                        vx: (Math.random() - 0.5) * 6,
                        vy: Math.random() * 4,
                        life: 30,
                        maxLife: 30,
                        color: this.isLowEndDevice ? '#00FFFF' : `hsl(${180 + Math.random() * 60}, 100%, 70%)`
                    });
                }
                
                // PARTÍCULAS ADICIONALES SOLO EN DISPOSITIVOS POTENTES
                if (!this.isLowEndDevice) {
                    for (let i = 0; i < 6; i++) {
                        this.particles.push({
                            x: this.runner.x + this.runner.width / 2,
                            y: this.runner.y + this.runner.height / 2,
                            vx: (Math.random() - 0.5) * 8,
                            vy: (Math.random() - 0.5) * 8,
                            life: 40,
                            maxLife: 40,
                            color: `hsl(${Math.random() * 360}, 100%, 80%)`
                        });
                    }
                }
            }
            
            createDashEffect() {
                // Screen flash effect MÁS INTENSO
                this.canvas.style.animation = 'screenShake 0.2s ease-in-out';
                setTimeout(() => {
                    this.canvas.style.animation = '';
                }, 200);
                
                // DASH PARTICLES MÁS ESPECTACULARES
                for (let i = 0; i < 30; i++) {
                    this.particles.push({
                        x: this.runner.x + this.runner.width / 2,
                        y: this.runner.y + this.runner.height / 2,
                        vx: (Math.random() - 0.5) * 15, // Más velocidad
                        vy: (Math.random() - 0.5) * 15,
                        life: 60, // Más duración
                        maxLife: 60,
                        color: `hsl(${Math.random() * 360}, 100%, 90%)` // Más brillante
                    });
                }
                
                // RAYOS DE ENERGÍA
                for (let i = 0; i < 8; i++) {
                    this.particles.push({
                        x: this.runner.x + this.runner.width / 2,
                        y: this.runner.y + this.runner.height / 2,
                        vx: Math.cos(i * Math.PI / 4) * 20,
                        vy: Math.sin(i * Math.PI / 4) * 20,
                        life: 30,
                        maxLife: 30,
                        color: '#FFFFFF'
                    });
                }
            }
            
            update(deltaTime) {
                if (!this.gameState.running) return;
                
                // FÍSICA DEL CORREDOR - SALTO FUNCIONAL
                const groundY = this.canvas.height * 0.85; // Posición del suelo
                const groundHeight = this.canvas.height * 0.15; // Altura del suelo
                
                // Aplicar gravedad
                this.runner.velocityY += 0.5; // Gravedad
                this.runner.y += this.runner.velocityY;
                
                // Colisión con el suelo
                if (this.runner.y + this.runner.height >= groundY) {
                    this.runner.y = groundY - this.runner.height;
                    this.runner.velocityY = 0;
                    this.runner.onGround = true;
                } else {
                    this.runner.onGround = false;
                }
                
                // Horizontal movement
                this.runner.x += this.runner.velocityX;
                this.runner.velocityX *= this.runner.friction; // Fricción para frenar
                
                // Keep runner within screen bounds
                const margin = 20;
                if (this.runner.x < margin) {
                    this.runner.x = margin;
                    this.runner.velocityX = 0;
                } else if (this.runner.x > this.canvas.width - this.runner.width - margin) {
                    this.runner.x = this.canvas.width - this.runner.width - margin;
                    this.runner.velocityX = 0;
                }
                
                // Update dash cooldown
                if (this.runner.dashCooldown > 0) {
                    this.runner.dashCooldown--;
                }
                
                // Update invulnerability
                if (this.runner.invulnerable > 0) {
                    this.runner.invulnerable--;
                }
                
                // Spawn obstacles - MENOS FRECUENTES
                if (Math.random() < 0.008) { // Reducido de 0.02 a 0.008
                    this.spawnObstacle();
                }
                
                // Spawn power-ups - MÁS FRECUENTES PARA COMPENSAR
                if (Math.random() < 0.01) { // Aumentado de 0.005 a 0.01
                    this.spawnPowerUp();
                }
                
                // Spawn gems - MÁS FRECUENTES
                if (Math.random() < 0.015) { // Aumentado de 0.01 a 0.015
                    this.spawnGem();
                }
                
                // Update obstacles
                this.obstacles.forEach((obstacle, index) => {
                    obstacle.x -= this.gameState.speed;
                    
                    // Collision detection
                    if (this.checkCollision(this.runner, obstacle)) {
                        if (this.runner.invulnerable <= 0) {
                            this.gameOver();
                        }
                    }
                    
                    // Remove off-screen obstacles
                    if (obstacle.x < -obstacle.width) {
                        this.obstacles.splice(index, 1);
                        this.gameState.score += 10;
                        this.gameState.combo += 1;
                    }
                });
                
                // Update power-ups
                this.powerUps.forEach((powerUp, index) => {
                    powerUp.x -= this.gameState.speed;
                    powerUp.rotation += 0.1;
                    
                    if (this.checkCollision(this.runner, powerUp)) {
                        this.collectPowerUp(powerUp);
                        this.powerUps.splice(index, 1);
                    }
                    
                    if (powerUp.x < -powerUp.width) {
                        this.powerUps.splice(index, 1);
                    }
                });
                
                // Update gems
                this.gems.forEach((gem, index) => {
                    gem.x -= this.gameState.speed;
                    gem.rotation += 0.15;
                    
                    if (this.checkCollision(this.runner, gem)) {
                        this.collectGem(gem);
                        this.gems.splice(index, 1);
                    }
                    
                    if (gem.x < -gem.width) {
                        this.gems.splice(index, 1);
                    }
                });
                
                // Update particles
                this.particles.forEach((particle, index) => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life--;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(index, 1);
                    }
                });
                
                // Increase speed - PROGRESIÓN MÁS AGRESIVA
                this.gameState.speed += 0.003; // Aumentado de 0.001 a 0.003
                
                // Update score
                this.gameState.score += Math.floor(this.gameState.speed * this.gameState.combo);
            }
            
            spawnObstacle() {
                const types = ['normal', 'tall', 'wide', 'boss'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                const groundY = this.canvas.height * 0.85; // 85% DE LA PANTALLA
                
                let obstacle = {
                    x: this.canvas.width,
                    y: groundY - 30, // POR ENCIMA DEL SUELO
                    width: 30,
                    height: 30,
                    type: type
                };
                
                switch (type) {
                    case 'tall':
                        obstacle.height = 60;
                        obstacle.y = groundY - obstacle.height;
                        break;
                    case 'wide':
                        obstacle.width = 60;
                        obstacle.y = groundY - 30; // POR ENCIMA DEL SUELO
                        break;
                    case 'boss':
                        obstacle.width = 80;
                        obstacle.height = 80;
                        obstacle.y = groundY - obstacle.height;
                        break;
                }
                
                this.obstacles.push(obstacle);
                console.log(`🚧 Obstáculo creado: ${type} en y=${obstacle.y}, suelo=${groundY}`);
            }
            
            spawnPowerUp() {
                const types = ['speed', 'jump', 'shield', 'magnet'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                const groundY = this.canvas.height * 0.85; // 85% DE LA PANTALLA
                
                this.powerUps.push({
                    x: this.canvas.width,
                    y: groundY - 40, // POR ENCIMA DEL SUELO
                    width: 25,
                    height: 25,
                    type: type,
                    rotation: 0
                });
            }
            
            spawnGem() {
                const groundY = this.canvas.height * 0.85; // 85% DE LA PANTALLA
                
                this.gems.push({
                    x: this.canvas.width,
                    y: groundY - 30, // POR ENCIMA DEL SUELO
                    width: 15,
                    height: 15,
                    rotation: 0,
                    value: Math.floor(Math.random() * 5) + 1
                });
            }
            
            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }
            
            collectPowerUp(powerUp) {
                switch (powerUp.type) {
                    case 'speed':
                        this.gameState.speed += 2;
                        break;
                    case 'jump':
                        this.runner.velocityY = -20;
                        break;
                    case 'shield':
                        this.runner.invulnerable = 180; // 3 seconds
                        break;
                    case 'magnet':
                        // Attract nearby gems
                        this.gems.forEach(gem => {
                            const dx = this.runner.x - gem.x;
                            const dy = this.runner.y - gem.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < 100) {
                                gem.x += dx * 0.1;
                                gem.y += dy * 0.1;
                            }
                        });
                        break;
                }
                
                this.createPowerUpEffect(powerUp);
            }
            
            collectGem(gem) {
                this.gameState.score += gem.value * 100 * this.gameState.combo;
                this.createGemEffect(gem);
            }
            
            createPowerUpEffect(powerUp) {
                // EFECTO MÁS ESPECTACULAR PARA POWER-UPS
                for (let i = 0; i < 25; i++) {
                    this.particles.push({
                        x: powerUp.x + powerUp.width / 2,
                        y: powerUp.y + powerUp.height / 2,
                        vx: (Math.random() - 0.5) * 12, // Más velocidad
                        vy: (Math.random() - 0.5) * 12,
                        life: 60, // Más duración
                        maxLife: 60,
                        color: `hsl(${120 + Math.random() * 60}, 100%, 80%)` // Más brillante
                    });
                }
                
                // EXPLOSIÓN DE ENERGÍA
                for (let i = 0; i < 12; i++) {
                    this.particles.push({
                        x: powerUp.x + powerUp.width / 2,
                        y: powerUp.y + powerUp.height / 2,
                        vx: Math.cos(i * Math.PI / 6) * 15,
                        vy: Math.sin(i * Math.PI / 6) * 15,
                        life: 40,
                        maxLife: 40,
                        color: '#00FF00'
                    });
                }
            }
            
            createGemEffect(gem) {
                // EFECTO MÁS ESPECTACULAR PARA GEMAS
                for (let i = 0; i < 20; i++) {
                    this.particles.push({
                        x: gem.x + gem.width / 2,
                        y: gem.y + gem.height / 2,
                        vx: (Math.random() - 0.5) * 8, // Más velocidad
                        vy: (Math.random() - 0.5) * 8,
                        life: 40, // Más duración
                        maxLife: 40,
                        color: `hsl(${60 + Math.random() * 60}, 100%, 90%)` // Más brillante
                    });
                }
                
                // CHISPAS DORADAS
                for (let i = 0; i < 8; i++) {
                    this.particles.push({
                        x: gem.x + gem.width / 2,
                        y: gem.y + gem.height / 2,
                        vx: Math.cos(i * Math.PI / 4) * 10,
                        vy: Math.sin(i * Math.PI / 4) * 10,
                        life: 30,
                        maxLife: 30,
                        color: '#FFD700'
                    });
                }
            }
            
            render() {
                // Clear canvas
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw background
                this.drawBackground();
                
                // Draw ground
                this.drawGround();
                
                // Draw obstacles
                this.obstacles.forEach(obstacle => this.drawObstacle(obstacle));
                
                // Draw power-ups
                this.powerUps.forEach(powerUp => this.drawPowerUp(powerUp));
                
                // Draw gems
                this.gems.forEach(gem => this.drawGem(gem));
                
                // Draw runner - PRINCIPAL
                this.drawRunner();
                
                // Draw particles
                this.particles.forEach(particle => this.drawParticle(particle));
                
                // Draw UI
                this.drawUI();
            }
            
            drawBackground() {
                // Animated background
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#000');
                gradient.addColorStop(0.5, '#111');
                gradient.addColorStop(1, '#000');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // OPTIMIZADO PARA SAMSUNG - MENOS ESTRELLAS Y CÁLCULOS
                const speedMultiplier = Math.min(this.gameState.speed / 4, 3);
                this.ctx.fillStyle = '#00FFFF';
                
                const starCount = this.isLowEndDevice ? 30 : 60; // Menos estrellas en dispositivos de gama baja
                const timeOffset = this.isLowEndDevice ? 
                    Math.floor(Date.now() * 0.01) : // Menos precisión temporal
                    Date.now() * speedMultiplier * 0.01;
                
                for (let i = 0; i < starCount; i++) {
                    const x = (i * 37 + timeOffset) % this.canvas.width;
                    const y = (i * 23) % this.canvas.height;
                    const size = this.isLowEndDevice ? 2 : (Math.sin(Date.now() * 0.001 + i) * 2 + 2);
                    this.ctx.fillRect(x, y, size, size);
                }
                
                // LÍNEAS DE VELOCIDAD SOLO EN DISPOSITIVOS POTENTES
                if (!this.isLowEndDevice && this.gameState.speed > 8) {
                    this.ctx.strokeStyle = `rgba(0, 255, 255, ${Math.min((this.gameState.speed - 8) / 10, 0.3)})`;
                    this.ctx.lineWidth = 2;
                    for (let i = 0; i < 3; i++) { // Menos líneas
                        const x = (Date.now() * speedMultiplier * 0.02 + i * 300) % this.canvas.width;
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, 0);
                        this.ctx.lineTo(x, this.canvas.height);
                        this.ctx.stroke();
                    }
                }
            }
            
            drawGround() {
                // SUELO ELEGANTE EN LA PARTE INFERIOR
                const groundY = this.canvas.height * 0.85; // 85% DE LA PANTALLA
                const groundHeight = this.canvas.height * 0.15; // 15% DE LA PANTALLA
                
                // Suelo con gradiente elegante
                const gradient = this.ctx.createLinearGradient(0, groundY, 0, groundY + groundHeight);
                gradient.addColorStop(0, '#1a1a2e');
                gradient.addColorStop(0.5, '#16213e');
                gradient.addColorStop(1, '#0f3460');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, groundY, this.canvas.width, groundHeight);
                
                // Línea superior del suelo - NEON AZUL
                this.ctx.strokeStyle = '#00FFFF';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(0, groundY);
                this.ctx.lineTo(this.canvas.width, groundY);
                this.ctx.stroke();
                
                // Efecto de brillo en la línea
                this.ctx.strokeStyle = '#FFFFFF';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(0, groundY);
                this.ctx.lineTo(this.canvas.width, groundY);
                this.ctx.stroke();
                
                // Guardar posición para física
                this.groundY = groundY;
            }
            
            drawRunner() {
                // CORREDOR ELEGANTE Y PROPORCIONADO
                console.log(`🏃‍♂️ DIBUJANDO CORREDOR: x=${this.runner.x}, y=${this.runner.y}, w=${this.runner.width}, h=${this.runner.height}`);
                
                // Cuerpo del corredor - AZUL NEON
                this.ctx.fillStyle = '#00FFFF';
                this.ctx.fillRect(this.runner.x, this.runner.y, this.runner.width, this.runner.height);
                
                // Cabeza del corredor
                this.ctx.fillStyle = '#FF6B6B';
                this.ctx.fillRect(this.runner.x + 10, this.runner.y, this.runner.width - 20, 30);
                
                // Ojos
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.fillRect(this.runner.x + 15, this.runner.y + 10, 8, 8);
                this.ctx.fillRect(this.runner.x + 35, this.runner.y + 10, 8, 8);
                
                // Borde del corredor
                this.ctx.strokeStyle = '#FFFFFF';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(this.runner.x, this.runner.y, this.runner.width, this.runner.height);
            }
            
            drawObstacle(obstacle) {
                this.ctx.save();
                
                this.ctx.shadowColor = '#FF0000';
                this.ctx.shadowBlur = 15;
                this.ctx.fillStyle = '#FF0000';
                this.ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                
                this.ctx.restore();
            }
            
            drawPowerUp(powerUp) {
                this.ctx.save();
                
                this.ctx.translate(powerUp.x + powerUp.width / 2, powerUp.y + powerUp.height / 2);
                this.ctx.rotate(powerUp.rotation);
                
                this.ctx.shadowColor = '#00FF00';
                this.ctx.shadowBlur = 10;
                this.ctx.fillStyle = '#00FF00';
                this.ctx.fillRect(-powerUp.width / 2, -powerUp.height / 2, powerUp.width, powerUp.height);
                
                this.ctx.restore();
            }
            
            drawGem(gem) {
                this.ctx.save();
                
                this.ctx.translate(gem.x + gem.width / 2, gem.y + gem.height / 2);
                this.ctx.rotate(gem.rotation);
                
                this.ctx.shadowColor = '#FFFF00';
                this.ctx.shadowBlur = 8;
                this.ctx.fillStyle = '#FFFF00';
                this.ctx.fillRect(-gem.width / 2, -gem.height / 2, gem.width, gem.height);
                
                this.ctx.restore();
            }
            
            drawParticle(particle) {
                this.ctx.save();
                
                const alpha = particle.life / particle.maxLife;
                this.ctx.globalAlpha = alpha;
                this.ctx.fillStyle = particle.color;
                this.ctx.fillRect(particle.x, particle.y, 3, 3);
                
                this.ctx.restore();
            }
            
            drawUI() {
                // Score
                document.getElementById('scoreDisplay').textContent = `SCORE: ${this.gameState.score}`;
                
                // Combo
                document.getElementById('comboDisplay').textContent = `COMBO: ${this.gameState.combo}x`;
                
                // FPS
                document.getElementById('fpsDisplay').textContent = `FPS: ${this.gameState.fps}`;
            }
            
            gameOver() {
                this.gameState.running = false;
                document.getElementById('finalScore').textContent = `SCORE: ${this.gameState.score}`;
                document.getElementById('gameOverScreen').style.display = 'flex';
                
                // ESTRATEGIA INTELIGENTE DE MONETIZACIÓN
                // 1. Siempre mostrar banners en game over (no invasivo)
                showAds();
                
                // 2. Interstitial solo cada 3 partidas perdidas Y cada 5 minutos mínimo
                if (!this.gamesPlayed) this.gamesPlayed = 0;
                if (!this.lastInterstitialTime) this.lastInterstitialTime = 0;
                
                this.gamesPlayed++;
                const currentTime = Date.now();
                const timeSinceLastInterstitial = currentTime - this.lastInterstitialTime;
                const shouldShowInterstitial = (this.gamesPlayed % 3 === 0) && (timeSinceLastInterstitial > 300000); // 5 minutos
                
                if (shouldShowInterstitial) {
                    // Mostrar interstitial
                    const ad = document.getElementById('gameOverAd');
                    if (ad) ad.style.display = 'block';
                    this.lastInterstitialTime = currentTime;
                    
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'ad_impression', {
                            game_name: 'neon_runner_wow',
                            ad_type: 'interstitial'
                        });
                    }
                }
                
                // 🏆 INTEGRACIÓN DEL LEADERBOARD - MOSTRAR RANKING DESPUÉS DE GAME OVER
                setTimeout(() => {
                    try {
                        // Crear o usar leaderboard existente
                        if (!window.leaderboard) {
                            window.leaderboard = new DailyLeaderboard('neon-runner-wow');
                        }
                        
                        // Enviar puntuación al leaderboard (esto mostrará el prompt de nombre si es necesario)
                        const level = Math.floor(this.gameState.score / 1000) + 1;
                        const success = window.leaderboard.submitScore(this.gameState.score, level, this.gameState.combo);
                        
                        if (success) {
                            console.log(`🏆 Puntuación enviada al leaderboard: ${this.gameState.score}, nivel: ${level}, combo: ${this.gameState.combo}`);
                        } else {
                            console.log('🏆 Puntuación guardada para envío posterior');
                        }
                    } catch(e) {
                        console.warn('Error en leaderboard:', e);
                    }
                }, 1000); // Esperar 1 segundo para que se vea la pantalla de game over
                
                // Track game over
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'game_over', {
                        game_name: 'neon_runner_wow',
                        score: this.gameState.score,
                        combo: this.gameState.combo
                    });
                }
            }
            
            gameLoop(currentTime = 0) {
                // Calculate delta time
                this.gameState.deltaTime = currentTime - this.gameState.lastTime;
                this.gameState.lastTime = currentTime;
                
                // Calculate FPS (con límite para evitar valores extremos)
                if (this.gameState.deltaTime > 0) {
                    this.gameState.fps = Math.min(120, Math.round(1000 / this.gameState.deltaTime));
                }
                
                // OPTIMIZACIÓN PARA SAMSUNG - SKIP FRAMES SI ES NECESARIO
                if (this.isLowEndDevice && this.gameState.fps < 30) {
                    // En dispositivos de gama baja, actualizar menos frecuentemente
                    if (this.frameSkipCounter === undefined) this.frameSkipCounter = 0;
                    this.frameSkipCounter++;
                    
                    if (this.frameSkipCounter % 2 === 0) { // Skip cada 2 frames
                        this.update(this.gameState.deltaTime * 2);
                        this.render();
                    }
                } else {
                    // Dispositivos normales - renderizado completo
                    this.update(this.gameState.deltaTime);
                    this.render();
                }
                
                // Continue loop
                requestAnimationFrame((time) => this.gameLoop(time));
            }
        }
        
        // ===== GAME FUNCTIONS =====
        let game;
        
        function startGame() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            
            // Hide ads during gameplay
            hideAds();
            
            // Reinitialize game
            if (game) {
                game.gameState.running = true;
                game.runner.x = 50; // MÁS A LA IZQUIERDA
                game.runner.y = window.innerHeight * 0.75; // 75% de la pantalla (sobre el suelo)
                game.runner.velocityY = 0;
                game.runner.onGround = true;
                console.log('🎮 Game restarted, runner position reset');
            } else {
                game = new UltraOptimizedGame();
                game.gameState.running = true;
                console.log('🎮 New game created');
            }
            
            // Track game start
            if (typeof gtag !== 'undefined') {
                gtag('event', 'game_start', {
                    game_name: 'neon_runner_wow'
                });
            }
        }
        
        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            
            if (game) {
                game.gameState.running = true;
                game.gameState.score = 0;
                game.gameState.combo = 1;
                game.gameState.speed = 4;
                game.obstacles = [];
                game.particles = [];
                game.powerUps = [];
                game.gems = [];
                game.runner.x = 50; // MÁS A LA IZQUIERDA
                game.runner.y = window.innerHeight * 0.75; // 75% de la pantalla (sobre el suelo)
                game.runner.velocityY = 0;
                game.runner.onGround = true;
                game.runner.dashCooldown = 0;
                game.runner.invulnerable = 0;
                console.log('🔄 Game restarted completely');
            }
            
            // Track restart
            if (typeof gtag !== 'undefined') {
                gtag('event', 'game_restart', {
                    game_name: 'neon_runner_wow'
                });
            }
        }
        
        // ===== AD MANAGEMENT =====
        function showAds() {
            document.getElementById('topBanner').style.display = 'block';
            document.getElementById('bottomBanner').style.display = 'block';
            document.getElementById('sideBanner').style.display = 'block';
        }
        
        function hideAds() {
            document.getElementById('topBanner').style.display = 'none';
            document.getElementById('bottomBanner').style.display = 'none';
            document.getElementById('sideBanner').style.display = 'none';
            // FORZAR OCULTACIÓN DEL BANNER LATERAL DURANTE EL JUEGO
            const sideBanner = document.getElementById('sideBanner');
            if (sideBanner) {
                sideBanner.style.display = 'none';
                sideBanner.style.visibility = 'hidden';
            }
        }
        
        // ===== LEADERBOARD FUNCTIONS =====
        
        function showLeaderboard(gameId) {
            try {
                // Crear o usar leaderboard existente
                if (!window.leaderboard) {
                    window.leaderboard = new DailyLeaderboard('neon-runner-wow');
                }
                
                // Si no hay usuario, pedir nombre primero
                if (!window.leaderboard.currentUser) {
                    window.leaderboard.showNamePrompt(false);
                    // Después de que el usuario ingrese su nombre, mostrar el ranking
                    setTimeout(() => {
                        if (window.leaderboard.currentUser) {
                            window.leaderboard.showRanking({ 
                                name: window.leaderboard.currentUser.name, 
                                score: window.leaderboard.currentUser.bestScore || 0 
                            });
                        }
                    }, 100);
                } else {
                    // Mostrar ranking directamente
                    window.leaderboard.showRanking({ 
                        name: window.leaderboard.currentUser.name, 
                        score: window.leaderboard.currentUser.bestScore || 0 
                    });
                }
                
                console.log('🏆 Mostrando leaderboard del Neon Runner WOW');
            } catch (e) { 
                console.warn('Error al mostrar leaderboard:', e);
                alert('Error al cargar el ranking. Inténtalo de nuevo.');
            }
        }
        
        function hideLeaderboard() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
            document.getElementById('menuScreen').style.display = 'flex';
        }
        
        // ===== INITIALIZATION =====
        window.addEventListener('load', () => {
            console.log('🚀 Initializing Neon Runner WOW...');
            
            // 🏆 INICIALIZAR LEADERBOARD
            try {
                window.leaderboard = new DailyLeaderboard('neon-runner-wow');
                console.log('✅ Leaderboard inicializado para Neon Runner WOW');
                console.log('🏆 Usuario actual:', window.leaderboard.currentUser);
                console.log('🏆 Ranking actual:', window.leaderboard.getRanking());
            } catch (e) {
                console.warn('Error al inicializar leaderboard:', e);
            }
            
            // TEST INMEDIATO DEL CANVAS
            const testCanvas = document.getElementById('gameCanvas');
            if (testCanvas) {
                console.log('✅ Canvas encontrado:', testCanvas);
                const testCtx = testCanvas.getContext('2d');
                if (testCtx) {
                    console.log('✅ Context obtenido:', testCtx);
                    
                    // Test básico de dibujo
                    testCtx.fillStyle = '#FF0000';
                    testCtx.fillRect(0, 0, 100, 100);
                    testCtx.fillStyle = '#FFFFFF';
                    testCtx.font = '20px Arial';
                    testCtx.fillText('TEST CANVAS', 10, 50);
                    console.log('✅ Test de dibujo completado');
                } else {
                    console.error('❌ No se pudo obtener context del canvas');
                }
            } else {
                console.error('❌ Canvas no encontrado');
            }
            
            // Initialize game
            game = new UltraOptimizedGame();
            
            // Initialize leaderboard
            setTimeout(() => {
                try { 
                    window.leaderboard = new DailyLeaderboard('neon-runner-wow'); 
                } catch(e) { 
                    console.warn('Leaderboard init error', e); 
                }
            }, 100);
            
            // Show ads in menu
            showAds();
            
            // Track page view
            if (typeof gtag !== 'undefined') {
                gtag('event', 'page_view', {
                    game_name: 'neon_runner_wow'
                });
            }
            
            // Initialize AdSense
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
            } catch(e) {
                console.log('AdSense not loaded yet');
            }
            
            console.log('✅ Neon Runner WOW initialized successfully!');
        });
        
        // Handle resize
        window.addEventListener('resize', () => {
            if (game) {
                game.setupCanvas();
            }
        });
        
        // ===== SHARE FUNCTIONS =====
        function shareScore() {
            const score = game ? game.gameState.score : 0;
            const combo = game ? game.gameState.combo : 1;
            const level = Math.floor(score / 1000) + 1;
            
            // Obtener información del leaderboard si está disponible
            let rankInfo = '';
            if (window.leaderboard && window.leaderboard.currentUser) {
                const userRank = window.leaderboard.getUserRank();
                const badgesCount = window.leaderboard.badges.length;
                rankInfo = `\n🏆 Ranking: #${userRank || 'No clasificado'}\n🏅 Badges: ${badgesCount}`;
            }
            
            const shareText = `🏃‍♂️ ¡Acabo de conseguir ${score.toLocaleString()} puntos en Neon Runner WOW! 🎮\n\n🔥 Combo: ${combo}x\n🎯 Nivel: ${level}${rankInfo}\n\n🚀 ¡Juega tú también en https://runnerwow.netlify.app!\n\n#NeonRunnerWOW #LIPAStudios #JuegosNeon`;
            
            // Intentar compartir nativo
            if (navigator.share) {
                navigator.share({
                    title: 'Neon Runner WOW - Mi Puntuación',
                    text: shareText,
                    url: 'https://runnerwow.netlify.app'
                }).then(() => {
                    console.log('✅ Compartido exitosamente');
                    // Track sharing event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'share', {
                            method: 'native',
                            content_type: 'game_score',
                            score: score
                        });
                    }
                }).catch((error) => {
                    console.log('Error al compartir:', error);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }
        
        // Fallback para compartir
        function fallbackShare(text) {
            // Copiar al portapapeles
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('📋 ¡Texto copiado! Pega en tu red social favorita');
                    // Track sharing event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'share', {
                            method: 'clipboard',
                            content_type: 'game_score',
                            score: game ? game.score : 0
                        });
                    }
                }).catch(() => {
                    // Fallback manual
                    prompt('📋 Copia este texto para compartir:', text);
                });
            } else {
                // Fallback manual
                prompt('📋 Copia este texto para compartir:', text);
            }
        }
    </script>
</body>
</html>
